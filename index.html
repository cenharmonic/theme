<script>

// constant
NUMBER_ROW = ['Backquote', 'Digit1', 'Digit2', 'Digit3', 'Digit4', 'Digit5', 'Digit6', 'Digit7', 'Digit8', 'Digit9', 'Digit0', 'Minus', 'Equal', 'Backspace']
HIGH_ROW = ['KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backslash']
HOME_ROW = ['KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote']
LOW_ROW = ['KeyZ', 'KeyX', 'KeyC', 'KeyV', 'KeyB', 'KeyN', 'KeyM', 'Comma', 'Period', 'Slash']
TONE_KEYS = LOW_ROW.concat(HOME_ROW).concat(HIGH_ROW);
TONE_KEY_OFFSET = 4;
KEY_CHANGE_KEYS = NUMBER_ROW

// LOW_ROW = 
BASE_TONIC = 110;
MAJOR = [1, 3, 5, 6, 8, 10, 12]
MINOR = [1, 3, 4, 6, 8, 9, 11]
EQUAL_TEMPERAMENT = KEY_CHANGE_KEYS.map(function(_, index) {
	return Math.pow(2, index/12.0);
})
function make_modifiers(keys) {
	return TONE_KEYS.map(function(_, index) {
		index += TONE_KEY_OFFSET;
		var rem = Math.floor(index / MAJOR.length);
		var rat = keys[index % MAJOR.length] - 1;
		return Math.pow(2, rem + (rat/12.0));
	});	
}

function index_to_frequency(index, modifiers) {
	return tonic * modifiers[index % modifiers.length]
}

MAJOR_MODIFIERS = make_modifiers(MAJOR);
MINOR_MODIFIERS = make_modifiers(MINOR);

// stateful
var context = new AudioContext();
var tonic = BASE_TONIC;
var oscillators = [];
oscillators.length = TONE_KEYS.length;

addEventListener('keydown', function(event) {
	var index = TONE_KEYS.indexOf(event.code);
	var modifiers = event.getModifierState('CapsLock') ? MINOR_MODIFIERS : MAJOR_MODIFIERS;
	if (index != -1) {
		if (oscillators[index]) {
			return;
		}
		// start an oscillator
		var oscillator = context.createOscillator();
		oscillators[index] = oscillator;
		oscillator.frequency.value = index_to_frequency(index, modifiers);
		oscillator.connect(context.destination);
		oscillator.start();
	} else {
		var index = KEY_CHANGE_KEYS.indexOf(event.code);
		if (index != -1) {
			tonic = BASE_TONIC * EQUAL_TEMPERAMENT[index];
			oscillators.map(function(oscillator, index) {
				if (oscillator) {
					oscillator.frequency.value = index_to_frequency(index, modifiers);
				}
			})
		}
	}
})

addEventListener('keyup', function(event) {
	var index = TONE_KEYS.indexOf(event.code);
	if (index != -1) {
		if (oscillators[index]) {
			oscillators[index].stop();
			oscillators[index] = undefined;
		}
	}
})

addEventListener('blur', function(event) {
	oscillators.map(function(oscillator, index) {
		if (oscillator) {
			oscillator.stop();	
		}
		return undefined;
	})
})

</script>

<ul>
<li>Letter and punctuation keys play tones in the major scale.  A in Qwerty is the tonic.</li>
<li>Keys in the number row change the key.  Tilde is A 220.</li>
<li>Switches to minor when caps lock is enabled.</li>
</ul>
