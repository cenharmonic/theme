<script>
var context = new AudioContext();

HIGH_ROW = ['KeyQ', 'KeyW', 'KeyE', 'KeyR', 'KeyT', 'KeyY', 'KeyU', 'KeyI', 'KeyO', 'KeyP', 'BracketLeft', 'BracketRight', 'Backslash']
HOME_ROW = ['KeyA', 'KeyS', 'KeyD', 'KeyF', 'KeyG', 'KeyH', 'KeyJ', 'KeyK', 'KeyL', 'Semicolon', 'Quote']
OSCILLATORS = [];
OSCILLATORS.length = HOME_ROW.length;
BASE_TONIC = 440;
TONIC = BASE_TONIC;
MAJOR = [1, 3, 5, 6, 8, 10, 12]
EQUAL_TEMPERAMENT = HIGH_ROW.map(function(_, index) {
	return Math.pow(2, index/12.0);
})
MODIFIERS = HOME_ROW.map(function(_, index) {
	index += 5;
	var rem = Math.floor(index / MAJOR.length);
	var rat = MAJOR[index % MAJOR.length] - 1;
	return Math.pow(2, rem + (rat/12.0));
})



// MODIFIERS = [1, 14.0/12, 16.0/12, 17.0/12, 19.0/12, 21.0/12, 23.0/12]
// MODIFIERS = [1, Math.pow(2, 1/12), 14.0/12, 16.0/12, 17.0/12, 19.0/12, 21.0/12, 23.0/12]


addEventListener('keydown', function(event) {
	var index = HOME_ROW.indexOf(event.code);
	if (index != -1 && !OSCILLATORS[index]) {
		// start an oscillator
		var oscillator = context.createOscillator();
		OSCILLATORS[index] = oscillator;
		oscillator.frequency.value = TONIC * MODIFIERS[index % MODIFIERS.length];
		oscillator.connect(context.destination);
		oscillator.start();
	} else {
		var index = HIGH_ROW.indexOf(event.code);
		if (index != -1) {
			TONIC = BASE_TONIC * EQUAL_TEMPERAMENT[index];
		}
	}
})

addEventListener('keyup', function(event) {
	var index = HOME_ROW.indexOf(event.code);
	if (index != -1) {
		// stop an oscillator
		OSCILLATORS[index].stop();
		delete OSCILLATORS[index];
	}
})

</script>